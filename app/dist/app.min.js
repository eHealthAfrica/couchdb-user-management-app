"use strict";angular.module("myApp",["app.user","app.role","config","ngRoute"]).config(["$locationProvider","$routeProvider",function(a,b){a.hashPrefix("!"),b.otherwise({redirectTo:"/users/list"})}]),angular.module("config",[]).constant("SETTINGS",{userTypes:["dashboard","mobile"]}).value("PAGE_SIZE",10),angular.module("app.user",["ngRoute","ng.simple.table","ng.simple.pagination"]),angular.module("app.user").config(["$routeProvider",function(a){a.when("/users/list",{templateUrl:"user/partials/list.html",controller:"UserCtrl",controllerAs:"ctrl",resolve:{users:["userService","PAGE_SIZE",function(a,b){return a.getPage(0,b).then(function(a){return console.log(a),a})["catch"](function(a){return console.log(a),[]})}],selectedUser:function(){return null}}}).when("/users/create",{templateUrl:"user/partials/create.html",controller:"UserCtrl",controllerAs:"ctrl",resolve:{users:function(){return[]},selectedUser:function(){return null}}}).when("/users/edit/:id",{templateUrl:"user/partials/edit.html",controller:"UserCtrl",controllerAs:"ctrl",resolve:{users:function(){return[]},selectedUser:["userService","$route",function(a,b){return a.getOne(b.current.params.id).then(function(a){return a})["catch"](function(a){return console.log(a),null})}]}}).when("/users/view/:id",{templateUrl:"user/partials/view.html",controller:"UserCtrl",controllerAs:"ctrl",resolve:{users:function(){return[]},selectedUser:["userService","$route",function(a,b){return a.getOne(b.current.params.id).then(function(a){return a})["catch"](function(a){return console.log(a),null})}]}}).when("/users/delete/:id",{templateUrl:"user/partials/delete.html",controller:"UserCtrl",controllerAs:"ctrl",resolve:{users:function(){return[]},selectedUser:["userService","$route",function(a,b){return a.getOne(b.current.params.id).then(function(a){return a})["catch"](function(a){return console.log(a),null})}]}})}]),angular.module("app.user").controller("UserCtrl",["$rootScope","$scope","$location","userService","users","selectedUser","alertService","PAGE_SIZE",function(a,b,c,d,e,f,g,h){var i=this;i.users=_.map(e.rows,"value"),i.selectedUser=f,i.selection=[],i.simpleTableConfig={allowFilter:!1,allowSelect:!0,allowSort:!0,rowActions:["assign role","edit","show","delete"],rowActionClasses:["glyphicon glyphicon-user","glyphicon glyphicon-pencil","glyphicon glyphicon-eye-open","glyphicon glyphicon-trash"],tableHeader:["name","user_type","status"]},i.simplePaginationConfig={total:e.total_rows,offset:e.offset,pageSize:h},i.onPageRequested=function(a,b){d.getPage(b,a).then(function(a){i.users=_.map(a.rows,"value"),i.simplePaginationConfig.total=a.total_rows,i.simplePaginationConfig.offset=a.offset})["catch"](function(a){return console.log(a),[]})},i.rowActionCallback=function(a,b){var e="";switch(a){case 0:e="users/"+i.users[b][d.getSingleRecordKey()]+"/role/edit",c.path(e);break;case 1:e="users/edit/"+i.users[b][d.getSingleRecordKey()],c.path(e);break;case 2:e="users/view/"+i.users[b][d.getSingleRecordKey()],c.path(e);break;case 3:e="users/delete/"+i.users[b][d.getSingleRecordKey()],c.path(e)}},i.submitNewUserForm=function(){_.isEmpty(i.newUserForm.$error)&&d.create(_.pick(i.newUserForm,["name","password","email"])).then(function(){g.showSuccessMessage(i.newUserForm.name+" successfully created");var a="users/view/"+i.newUserForm.name;c.path(a)})["catch"](function(a){return"ValidationError"===a.data.name?void(i.newUserForm.$serverError=i.newUserForm.name):(console.log(a),void g.showErrorMessage("Entry was not created"))})},i.submitUpdateUserForm=function(){_.isEmpty(i.updateUserForm.$error)&&d.update(_.pick(i.updateUserForm,["name","password","email"])).then(function(a){g.showSuccessMessage("Changes successfully saved");var b="users/view/"+i.updateUserForm.name;c.path(b)})["catch"](function(a){g.showErrorMessage("Entry was not updated")})},i.deleteOne=function(a){d["delete"](a).then(function(b){g.showSuccessMessage(a+" successfully deleted"),c.path("users/list")})["catch"](function(){g.showErrorMessage("Entry was not created")})},i.bulkDelete=function(){},i.getSelectionCount=function(){return i.selection.filter(function(a){return a}).length}}]),angular.module("app.user").service("userService",["$http","$q",function(a,b){var c=this;this.baseUrl="api/users",this.singleRecordKey="name",this.setBaseUrl=function(a){c.baseUrl=a.replace(/\/$/,"")},this.setSingleRecordKey=function(a){c.singleRecordKey=a},this.getSingleRecordKey=function(){return c.singleRecordKey},this.getPage=function(b,d){var e=a({method:"GET",url:c.baseUrl,params:{skip:b,limit:d},withCredentials:!0});return e.then(function(a){return a.data},function(a){return a})},this.getOne=function(b){var d=a({url:c.baseUrl+"/"+b,withCredentials:!0});return d.then(function(a){return a.data})},this.create=function(b){b._id="org.couchdb.user:"+b.name;var d=a({method:"POST",url:c.baseUrl,data:b,withCredentials:!0});return d.then(function(){return delete b.password,b})},this.update=function(b){return a({method:"PUT",url:c.baseUrl+"/"+b[c.singleRecordKey],withCredentials:!0,data:b}).then(function(a){return a})},this["delete"]=function(b){return a({method:"DELETE",url:c.baseUrl+"/"+b,withCredentials:!0}).then(function(a){return a})}}]),angular.module("app.role",["ngRoute","app.user"]).config(["$routeProvider",function(a){a.when("/users/:id/role/edit",{templateUrl:"role/partials/edit.html",controller:"RoleCtrl",controllerAs:"ctrl",resolve:{user:["userService","$route",function(a,b){return a.getOne(b.current.params.id).then(function(a){return a})["catch"](function(a){return console.log(a),null})}],adminLevels:["adminLevelService",function(a){return a.getAll().then(function(a){return a})["catch"](function(a){return console.log(a),[]})}],locations:["locationService",function(a){return a.getAll().then(function(a){return a})["catch"](function(a){return console.log(a),[]})}],facilities:["facilityService",function(a){return a.getAll().then(function(a){return a})["catch"](function(a){return console.log(a),[]})}],programs:["programService",function(a){return a.getAll().then(function(a){return a})["catch"](function(a){return console.log(a),[]})}],facilityPrograms:["facilityProgramsService",function(a){return a.getAll().then(function(a){return a})["catch"](function(a){return console.log(a),[]})}]}})}]),angular.module("app.role").controller("RoleCtrl",["$scope","$location","userService","alertService","user","adminLevels","locations","facilities","programs","facilityPrograms","SETTINGS",function(a,b,c,d,e,f,g,h,i,j,k){var l=this;l.user=e,l.userTypes=k.userTypes,l.adminLevels=f,l.locations=g,l.facilities=h,l.programs=i,l.facilityPrograms=j,l.submitUpdateUserRoleForm=function(){if(!l.updateUserRoleForm.$error||_.isEmpty(l.updateUserRoleForm.$error)){if(l.updateUserRoleForm.lomis_stock={},l.updateUserRoleForm.type===l.userTypes[0]){l.updateUserRoleForm.lomis_stock.mobile={};var a=-1;for(var e in l.adminLevels)if(l.adminLevels[e]._id===l.updateUserRoleForm.access.level){a=e;break}l.updateUserRoleForm.lomis_stock.dashboard={access:{items:[],level:l.updateUserRoleForm.access.level}};var f={};f[l.updateUserRoleForm.access.level]=[],f[l.updateUserRoleForm.access.level].push(l.updateUserRoleForm.locations[a+""]),l.updateUserRoleForm.lomis_stock.dashboard.access.items.push(f)}else if(l.updateUserRoleForm.lomis_stock.dashboard={},l.updateUserRoleForm.facility){l.updateUserRoleForm.lomis_stock.mobile={},l.updateUserRoleForm.lomis_stock.mobile.facilities=[];var g={};g[l.updateUserRoleForm.facility]=[l.updateUserRoleForm.program],l.updateUserRoleForm.lomis_stock.mobile.facilities.push(g)}c.update({name:l.user.name,_id:l.user._id,lomis_stock:l.updateUserRoleForm.lomis_stock}).then(function(a){d.showSuccessMessage("Changes successfully saved");var c="users/view/"+l.user.name;b.path(c)})["catch"](function(a){d.showErrorMessage("Entry was not updated"+a)})}},l.getUserType=function(){if(e&&e.lomis_stock){var a=Object.keys(e.lomis_stock),b="";for(var c in a)b+=_.isEmpty(e.lomis_stock[a[c]])?" "+a[c]:"";return b.trim()}return""},l.getLocation=function(a){}}]),angular.module("app.role").filter("getWithAncestors",function(){return function(a,b){if(!a||!b)return[];var c=[];for(var d in a)if(c.push(a[d]),a[d]._id===b)break;return c}}).filter("getChildrenLocation",function(){return function(a,b,c){return a.filter(function(a){return a.ancestors&&a.ancestors.length===c+1?a.ancestors.filter(function(a){return a._id===b&&a.level===c?!0:!1}).length>0:!1})}}).filter("getFacilitiesInLocation",function(){return function(a,b){if(b&&0!==b.length){var c=("location:"+b[(Object.keys(b).length-1).toString()]).replace(/\s/g,"-").toLowerCase();return a.filter(function(a){return a.location.ancestors?a.location.ancestors.filter(function(a){return a._id===c&&a.level===Object.keys(b).length-1}).length>0:!1})}return[]}}).filter("getProgramsInFacility",function(){return function(a,b,c){if(c&&b){var d=b.filter(function(a){return a.facility===c});return a.filter(function(a){return d.filter(function(b){return b.program===a._id}).length>0})}return[]}}),angular.module("app.role").service("adminLevelService",["$http",function(a){var b="/api/admin_level";this.getAll=function(){var c=a.get(b,{withCredentials:!0});return c.then(function(a){var b=[];for(var c in a.data)null===a.data[c].parent&&b.push(a.data[c]);for(var d=0;d<a.data.length;d++){var e=b[b.length-1]._id;for(var f in a.data)a.data[f].parent===e&&b.push(a.data[f])}return b},function(a){return a})}}]).service("facilityService",["$http",function(a){var b="/api/facilities";this.getAll=function(){var c=a.get(b,{withCredentials:!0});return c.then(function(a){return a.data},function(a){return a})}}]).service("facilityProgramsService",["$http",function(a){var b="/api/common/facility-program";this.getAll=function(){var c=a.get(b,{withCredentials:!0});return c.then(function(a){return a.data},function(a){return a})}}]).service("locationService",["$http",function(a){var b="/api/location";this.getAll=function(){var c=a.get(b,{withCredentials:!0});return c.then(function(a){return a.data},function(a){return a})}}]).service("programService",["$http",function(a){var b="/api/program";this.getAll=function(){var c=a.get(b,{withCredentials:!0});return c.then(function(a){return a.data},function(a){return a})}}]),angular.module("ng.simple.table",[]).directive("ngsimpletable",function(){return{scope:{allowFilter:"=",allowSelect:"=",allowSort:"=",filterFieldClass:"@",filterFieldPlaceholder:"@",headerClass:"@",rowActions:"=",rowActionCallback:"&",rowActionClass:"@",rowActionClasses:"=",rowClass:"@",rowSelection:"=",tableClass:"@",tableData:"=",tableHeader:"="},link:function(a,b,c){function d(){for(var b=[],c=0;c<a.tableData.length;c++)b.push(!1);return b}function e(a,b){function c(a,c){a=a[b],c=c[b];var d,e="string"==typeof a||"string"==typeof c?"string":"number";return d="string"===e?a.localeCompare(c):a-c}return a.sort(c)}a.rowSelection=d(),a.searchString="",a.selectAll=!1,a.tableDataCopy=a.tableData,a.$watch("tableData",function(b,c){a.rowSelection=d(),a.tableData.length>a.tableDataCopy.length&&(a.tableDataCopy=a.tableData)}),a.filter=function(){a.tableData=a.tableDataCopy,a.searchString&&0!==a.searchString.length&&(a.tableData=a.tableData.filter(function(b){for(var c in a.tableHeader)if(b[a.tableHeader[c]].toString().toLowerCase().startsWith(a.searchString.toLowerCase()))return!0;return!1})),a.rowSelection=d()},a.rowSelectionChanged=function(){},a.sortBy=function(b,c){1===c?a.tableData=e(a.tableData,a.tableHeader[b]):a.tableData=e(a.tableData,a.tableHeader[b]).reverse()},a.toggleSelectAll=function(){a.rowSelection=a.rowSelection.map(function(){return a.selectAll})}},restrict:"AEC",replace:!0,templateUrl:"components/ng-simple-table/template.html"}}),angular.module("ng.simple.pagination",[]).directive("ngsimplepagination",function(){return{scope:{total:"=",pageSize:"=",offset:"=",onPageRequested:"&"},link:function(a,b,c){a.currentPage=0,a.pageCount=0,a.pageResized=!1,a.pageStart=0,a.pageEnd=0,a.$watch("currentPage",function(b,c){a.pageStart=a.currentPage*a.pageSize+1,a.pageEnd=a.currentPage*a.pageSize+a.pageSize,a.pageStart>a.total&&(a.pageStart=a.total),a.pageEnd>a.total&&(a.pageEnd=a.total),b===c?(a.currentPage=Math.floor(a.offset/a.pageSize),a.pageCount=Math.ceil(a.total/a.pageSize),a.pageResized&&(a.pageResized=!1,a.onPageRequested({limit:a.pageSize,skip:b*a.offset}))):a.onPageRequested({limit:a.pageSize,skip:b*a.pageSize})}),a.$watch("total",function(b,c){a.pageCount=Math.ceil(a.total/a.pageSize-1)}),a.$watch("pageSize",function(b,c){b!==c&&(a.currentPage=0)}),a.navigateTo=function(b){a.currentPage=b}},restrict:"AEC",replace:!0,templateUrl:"components/ng-simple-pagination/template.html"}}),angular.module("app.user").service("alertService",function(){this.showMessage=function(a){humane.log(a)},this.showSuccessMessage=function(a){humane.log(a,{addnCls:"humane-flatty-success"})},this.showInfoMessage=function(a){humane.log(a,{addnCls:"humane-flatty-info"})},this.showErrorMessage=function(a){humane.log(a,{addnCls:"humane-flatty-error"})}});