"use strict";angular.module("myApp",["app.user","app.role","app.config","app.navbar","ngRoute","ngCookies","ui.bootstrap"]).factory("authInterceptor",["$rootScope","$q","$cookies","$window",function(a,b,c,d){return{request:function(a){return a.headers=a.headers||{},c.get("token")?a.headers.Authorization="Bearer ".concat(c.getObject("token")):d.location.href="/login",a},responseError:function(e){return 401===e.status?(a.$emit("unauthorized"),c.remove("token"),d.location.href="/login",b.reject(e)):b.reject(e)}}}]).config(["$locationProvider","$routeProvider","$httpProvider",function(a,b,c){a.hashPrefix("!"),c.interceptors.push("authInterceptor"),b.otherwise({redirectTo:"/users/list"})}]),angular.module("app.config",[]).service("configService",["$http",function(a){var b="api/config";this.get=function(){var c=a.get(b,{withCredentials:!0});return c.then(function(a){return a},function(a){return a})}}]),angular.module("app.config").constant("SETTINGS",{userTypes:["dashboard","mobile"],auth:{type:"COOKIES",cookies:{field:"token",authType:"bearer"},redirectUrl:"/"}}).value("USERS_TABLE_CONFIG",{allowFilter:!1,allowSelect:!0,allowSort:!0,arrayFields:[],header:["name","admin_level","location","status"],maxColWidth:25,roleDependedntFields:["admin_level","location"],rowActions:["assign role","edit","show","delete"],rowActionClasses:["glyphicon glyphicon-user","glyphicon glyphicon-pencil","glyphicon glyphicon-eye-open","glyphicon glyphicon-trash"],toggleFields:[{name:"status",positive:"active"}],unsortableFields:["location"]}).value("NAVIGATION",{customNavbarLinks:[{title:"Goto Dashboard",url:"/",iconClass:"fa fa-angle-right"}],sidebarLinks:[{title:"Back",url:"/admin",iconClass:"fa fa-chevron-left fa-fw"}],userDropdown:[{title:"logout",url:"/"}]}).value("CURRENT_USER",{url:"/api/users/me",name_field:"name"}).value("PAGE_SIZE",30),angular.module("app.user",["ngRoute","ng.simple.table","ng.simple.pagination","app.role"]),angular.module("app.user").config(["$routeProvider",function(a){a.when("/users/list",{templateUrl:"user/partials/list.html",controller:"UsersCtrl",controllerAs:"ctrl",resolve:{users:["userService","PAGE_SIZE",function(a,b){return a.getPage(0,b).then(function(a){return a})["catch"](function(a){return console.log(a),[]})}]}}).when("/users/create",{templateUrl:"user/partials/create.html",controller:"NewUserCtrl",controllerAs:"ctrl"}).when("/users/edit/:id",{templateUrl:"user/partials/edit.html",controller:"UserCtrl",controllerAs:"ctrl",resolve:{user:["userService","$route",function(a,b){return a.getOne(b.current.params.id).then(function(a){return a})["catch"](function(a){return console.log(a),null})}]}}).when("/users/view/:id",{templateUrl:"user/partials/view.html",controller:"UserCtrl",controllerAs:"ctrl",resolve:{user:["userService","$route",function(a,b){return a.getOne(b.current.params.id).then(function(a){return a})["catch"](function(a){return console.log(a),null})}]}}).when("/users/delete/:id",{templateUrl:"user/partials/delete.html",controller:"UserCtrl",controllerAs:"ctrl",resolve:{user:["userService","$route",function(a,b){return a.getOne(b.current.params.id).then(function(a){return a})["catch"](function(a){return console.log(a),null})}]}})}]),angular.module("app.user").controller("UserCtrl",["$scope","$location","alertService","userService","user",function(a,b,c,d,e){var f=this;f.user=e,f.submitNewUserForm=function(){_.isEmpty(f.newUserForm.$error)&&d.create(_.pick(f.newUserForm,["name","password","email"])).then(function(){c.showSuccessMessage(f.newUserForm.name+" successfully created");var a="users/view/"+f.newUserForm.name;b.path(a)})["catch"](function(a){return"ValidationError"===a.data.name?void(f.newUserForm.$serverError=f.newUserForm.name):void c.showErrorMessage("Entry was not created")})},f.submitUpdateUserForm=function(){_.isEmpty(f.updateUserForm.$error)&&d.update(_.pick(f.updateUserForm,["name","password","email"])).then(function(a){c.showSuccessMessage("Changes successfully saved");var d="users/view/"+f.updateUserForm.name;b.path(d)})["catch"](function(a){c.showErrorMessage("Entry was not updated")})},f.deleteOne=function(a){d["delete"](a).then(function(d){c.showSuccessMessage(a+" successfully deleted"),b.path("users/list")})["catch"](function(){c.showErrorMessage("Entry was not created")})}}]),angular.module("app.user").controller("UsersCtrl",["$scope","$location","alertService","userService","userDecoratorService","$filter","users","PAGE_SIZE","USERS_TABLE_CONFIG",function(a,b,c,d,e,f,g,h,i){function j(a){a&&a.rows&&a.rows.length>0&&a.rows[0].value?l.users=_.map(a.rows,"value"):l.users=a.rows,i.roleDependedntFields&&e.decorate(i.roleDependedntFields,l.users),l.simplePaginationConfig.total=a.total_rows,l.simplePaginationConfig.offset=a.offset}function k(a){l.users[a].status&&"inactive"!==l.users[a].status?l.users[a].status="inactive":l.users[a].status="active"}var l=this;l.searchString="",l.selection=[],l.simpleTableConfig=i,l.simplePaginationConfig={currentPage:0,total:g.total_rows,offset:g.offset,pageSize:h},l.sortOptions={by:null,direction:null},l.users=_.map(g.rows,"value"),a.users=g,a.$watch("users",function(b,c){void 0!==b&&null!==b&&(j(a.users),a.users=null)}),l.onSearchStringChanged=function(){l.searchString=l.searchString.trim(),l.requestPage(0,h)},l.requestPage=function(a,b){0===a&&(l.simplePaginationConfig.offset=0,l.simplePaginationConfig.currentPage=0);var c=0===l.searchString.length?d.getPage(a,h,l.sortOptions.by,l.sortOptions.direction):d.search(a,h,l.sortOptions.by,l.sortOptions.direction,l.searchString);c.then(function(a){j(a)})["catch"](function(a){console.log(a),j([])})},l.sort=function(a,b){l.sortOptions.by=a,l.sortOptions.direction=b,l.requestPage(0,h)},l.rowActionCallback=function(a,c){var e="";switch(a){case 0:e="users/"+l.users[c][d.getSingleRecordKey()]+"/role/edit",b.path(e);break;case 1:e="users/edit/"+l.users[c][d.getSingleRecordKey()],b.path(e);break;case 2:e="users/view/"+l.users[c][d.getSingleRecordKey()],b.path(e);break;case 3:e="users/delete/"+l.users[c][d.getSingleRecordKey()],b.path(e)}},l.toggleFieldCalllback=function(a,b){switch(a){case 0:k(b),d.update(l.users[b])["catch"](function(a){k(b)})}},l.getSelectionCount=function(){return l.selection.filter(function(a){return a}).length}}]),angular.module("app.user").service("userService",["$http","$q",function(a,b){var c=this;this.baseUrl="api/users",this.singleRecordKey="name",this.setBaseUrl=function(a){c.baseUrl=a.replace(/\/$/,"")},this.setSingleRecordKey=function(a){c.singleRecordKey=a},this.getSingleRecordKey=function(){return c.singleRecordKey},this.getPage=function(b,d,e,f){e||(e="name"),f||(f="asc");var g=a({method:"GET",url:c.baseUrl,params:{skip:b,limit:d,sortBy:e,sortDirection:f},withCredentials:!0});return g.then(function(a){return a.data},function(a){return a})},this.getOne=function(b){var d=a({url:c.baseUrl+"/"+b,withCredentials:!0});return d.then(function(a){return a.data})},this.search=function(b,d,e,f,g){e||(e="name"),f||(f="asc");var h=a({url:c.baseUrl+"/search/"+g,params:{skip:b,limit:d,sortBy:e,sortDirection:f},withCredentials:!0});return h.then(function(a){return a.data})},this.create=function(b){b._id="org.couchdb.user:"+b.name;var d=a({method:"POST",url:c.baseUrl,data:b,withCredentials:!0});return d.then(function(){return delete b.password,b})},this.update=function(b){return a({method:"PUT",url:c.baseUrl+"/"+b[c.singleRecordKey],withCredentials:!0,data:b}).then(function(a){return a})},this["delete"]=function(b){return a({method:"DELETE",url:c.baseUrl+"/"+b,withCredentials:!0}).then(function(a){return a})}}]),angular.module("app.user").controller("NewUserCtrl",["$scope","$location","alertService","userService",function(a,b,c,d){var e=this;e.submitNewUserForm=function(){_.isEmpty(e.newUserForm.$error)&&d.create(_.pick(e.newUserForm,["name","password","email"])).then(function(){c.showSuccessMessage(e.newUserForm.name+" successfully created");var a="users/view/"+e.newUserForm.name;b.path(a)})["catch"](function(a){return"ValidationError"===a.data.name?void(e.newUserForm.$serverError=e.newUserForm.name):void c.showErrorMessage("Entry was not created")})}}]),angular.module("app.user").service("userDecoratorService",function(){this.methods={},this.decorate=function(a,b){}}),angular.module("app.role",["ngRoute","app.user"]).config(["$routeProvider",function(a){a.when("/users/:id/role/edit",{templateUrl:"role/partials/edit.html",controller:"RoleCtrl",controllerAs:"ctrl",resolve:{user:["userService","$route",function(a,b){return a.getOne(b.current.params.id).then(function(a){return a})["catch"](function(a){return console.log(a),null})}],adminLevels:["adminLevelService",function(a){return a.getAll().then(function(a){return a})["catch"](function(a){return console.log(a),[]})}],locations:["locationService",function(a){return a.getAll().then(function(a){return a})["catch"](function(a){return console.log(a),[]})}],facilities:["facilityService",function(a){return a.getAll().then(function(a){return a})["catch"](function(a){return console.log(a),[]})}],programs:["programService",function(a){return a.getAll().then(function(a){return a})["catch"](function(a){return console.log(a),[]})}],facilityPrograms:["facilityProgramsService",function(a){return a.getAll().then(function(a){return a})["catch"](function(a){return console.log(a),[]})}]}})}]),angular.module("app.role").controller("ViewRoleCtrl",["$scope","adminLevelService","facilityService","locationService",function(a,b,c,d){var e=this;e.user=a.$parent.ctrl.user,e.adminLevels=[],e.locations=[],e.facilities=[],e.init=function(){b.getAll().then(function(a){e.adminLevels=a})["catch"](function(a){console.log(a)}),c.getAll().then(function(a){e.facilities=a})["catch"](function(a){console.log(a)}),d.getAll().then(function(a){e.locations=a})["catch"](function(a){console.log(a)})},e.hasNoRole=function(){return!e.user.lomis_stock},e.getRole=function(){return _.isEmpty(e.user.lomis_stock.mobile)&&_.isEmpty(e.user.lomis_stock.dashboard)?"None":_.isEmpty(e.user.lomis_stock.mobile)?"Dashboard":"Mobile"},e.isAnAdmin=function(){return e.user.lomis_stock.dashboard.is_admin},e.getAdminLevel=function(){if("Mobile"===e.getRole())return"Facility";var a=e.user.lomis_stock.dashboard.access.level;for(var b in e.adminLevels)if(e.adminLevels[b]._id===a)return e.adminLevels[b].name;return"Unknown Access Level"},e.getLocations=function(){if("Mobile"===e.getRole()){var a=e.user.lomis_stock.mobile.facilities,b="";for(var c in a){var d=Object.keys(a[c]);if(d.length>0)for(var c in e.facilities)e.facilities[c]._id===d[0]&&(b+=e.facilities[c].name+" ")}return b}var f=e.user.lomis_stock.dashboard.access.level,g=e.user.lomis_stock.dashboard.access.items,h=null;for(var c in g)if(g[c][f]){h=g[c][f];break}var i="";for(var c in h)for(var j in e.locations)e.locations[j]._id===h[c]&&(i+=e.locations[j].name);return i}}]),angular.module("app.role").controller("RoleCtrl",["$scope","$location","userService","alertService","user","adminLevels","locations","facilities","programs","facilityPrograms","SETTINGS",function(a,b,c,d,e,f,g,h,i,j,k){var l=this;l.user=e,l.userTypes=k.userTypes,l.adminLevels=f,l.locations=g,l.facilities=h,l.programs=i,l.facilityPrograms=j,a.$watch("vm.updateUserRoleForm.access.level",function(a,b){l.getAssignedLocation()}),l.submitUpdateUserRoleForm=function(){if(!l.updateUserRoleForm.$error||_.isEmpty(l.updateUserRoleForm.$error)){var a={dashboard:{},mobile:{}};switch(l.updateUserRoleForm.type){case"mobile":if(!l.updateUserRoleForm.facility||!l.updateUserRoleForm.program)return;var e={};e[l.updateUserRoleForm.facility]=[l.updateUserRoleForm.program],a.mobile.facilities=[e];break;case"dashboard":var f=-1;for(var g in l.adminLevels)if(l.adminLevels[g]._id===l.updateUserRoleForm.access.level){f=g;break}if(!l.updateUserRoleForm.locations[f+""])return;a.dashboard={access:{level:l.updateUserRoleForm.access.level},is_admin:l.updateUserRoleForm.is_admin||!1};var h={};h[l.updateUserRoleForm.access.level]=[l.updateUserRoleForm.locations[f+""]],a.dashboard.access.items=[h]}c.update({name:l.user.name,_id:l.user._id,lomis_stock:a}).then(function(a){d.showSuccessMessage("Changes successfully saved");var c="users/view/"+l.user.name;b.path(c)})["catch"](function(a){d.showErrorMessage("Entry was not updated"+a)})}},l.getAssignedLocation=function(){if(l.user.lomis_stock&&(l.user.lomis_stock.mobile||l.user.lomis_stock.dashboard))if(l.user.lomis_stock.mobile&&!_.isEmpty(l.user.lomis_stock.mobile)){if(l.updateUserRoleForm.facility)return void(l.updateUserRoleForm.program=null);var a=l.user.lomis_stock.mobile.facilities[0];l.updateUserRoleForm.facility=Object.keys(a)[0],l.updateUserRoleForm.program=l.user.lomis_stock.mobile.facilities[0][l.updateUserRoleForm.facility][0]}else if(l.user.lomis_stock.dashboard&&!_.isEmpty(l.user.lomis_stock.dashboard)){var b=l.user.lomis_stock.dashboard.access.level,c=l.user.lomis_stock.dashboard.access.items[0][b][0],d=null;for(var e in l.locations)if(l.locations[e]._id===c){d=l.locations[e];break}var f=_.orderBy(d.ancestors,["level"],["asc"]);l.updateUserRoleForm.locations=[];for(var e in f)l.updateUserRoleForm.locations[e]=f[e]._id;l.updateUserRoleForm.locations[f.length]=c}},l.getUserType=function(){if(e&&e.lomis_stock){if(e.lomis_stock.dashboard&&!_.isEmpty(e.lomis_stock.dashboard))return"dashboard";if(e.lomis_stocj.mobile&&!_.isEmpty(e.lomis_stock.mobile))return"mobile"}return""}}]),angular.module("app.role").filter("getWithAncestors",function(){return function(a,b){if(!a||!b)return[];var c=[];for(var d in a)if(c.push(a[d]),a[d]._id===b)break;return c}}).filter("getChildrenLocation",function(){return function(a,b,c){return a.filter(function(a){return a.ancestors&&a.ancestors.length===c+1?a.ancestors.filter(function(a){return a._id===b&&a.level===c?!0:!1}).length>0:!1})}}).filter("getFacilitiesInLocation",function(){return function(a,b){if(b&&0!==b.length){var c=("location:"+b[(Object.keys(b).length-1).toString()]).replace(/\s/g,"-").toLowerCase();return a.filter(function(a){return a.location.ancestors?a.location.ancestors.filter(function(a){return a._id===c&&a.level===Object.keys(b).length-1}).length>0:!1})}return[]}}).filter("getProgramsInFacility",function(){return function(a,b,c){if(c&&b){var d=b.filter(function(a){return a.facility===c});return a.filter(function(a){return d.filter(function(b){return b.program===a._id}).length>0})}return[]}}).filter("getUserType",function(){return function(a){return a.lomis_stock?_.isEmpty(a.lomis_stock.mobile)&&_.isEmpty(a.lomis_stock.dashboard)?"None":_.isEmpty(a.lomis_stock.mobile)?"Dashboard":"Mobile":"Unassigned"}}),angular.module("app.role").service("adminLevelService",["$http",function(a){var b="/api/admin_level";this.getAll=function(){var c=a.get(b,{withCredentials:!0});return c.then(function(a){var b=[];for(var c in a.data)null===a.data[c].parent&&b.push(a.data[c]);for(var d=0;d<a.data.length;d++){var e=b[b.length-1]._id;for(var f in a.data)a.data[f].parent===e&&b.push(a.data[f])}return b},function(a){return a})}}]).service("facilityService",["$http",function(a){var b="/api/facilities";this.getAll=function(){var c=a.get(b,{withCredentials:!0});return c.then(function(a){return a.data},function(a){return a})}}]).service("facilityProgramsService",["$http",function(a){var b="/api/common/facility-program";this.getAll=function(){var c=a.get(b,{withCredentials:!0});return c.then(function(a){return a.data},function(a){return a})}}]).service("locationService",["$http",function(a){var b="/api/location";this.getAll=function(){var c=a.get(b,{withCredentials:!0});return c.then(function(a){return a.data},function(a){return a})}}]).service("programService",["$http",function(a){var b="/api/program";this.getAll=function(){var c=a.get(b,{withCredentials:!0});return c.then(function(a){return a.data},function(a){return a})}}]),angular.module("app.user").decorate("userDecoratorService",["$delegate","$q","adminLevelService","facilityService","locationService",function(a,b,c,d,e){return a.decorate=function(a,f){var g=b.all([c.getAll(),d.getAll(),e.getAll()]);return g.then(function(a){function b(a){return!a.lomis_stock||!a.lomis_stock.mobile||!a.lomis_stock.dashboard||_.isEmpty(a.lomis_stock.mobile)&&_.isEmpty(a.lomis_stock.dashboard)?"None":_.isEmpty(a.lomis_stock.mobile)?"Dashboard":"Mobile"}function c(c){switch(b(c)){case"Mobile":return"Facility";case"None":return"Unassigned";case"Dashboard":var d=c.lomis_stock.dashboard.access.level;for(var e in a[0])if(a[0][e]._id===d)return a[0][e].name;return"Unknown Access Level"}}function d(c){if("None"===b(c))return null;if("Mobile"===b(c)){var d=c.lomis_stock.mobile.facilities,e="";for(var f in d){var g=Object.keys(d[f]);if(g.length>0)for(var h in a[1])a[1][h]._id===g[0]&&(e+=a[1][h].name+" ")}return e}var i=c.lomis_stock.dashboard.access.level,j=c.lomis_stock.dashboard.access.items,k=null;for(var f in j)if(j[f][i]){k=j[f][i];break}var l="";for(var f in k)for(var h in a[2])a[2][h]._id===k[f]&&(l+=a[2][h].name);return l}for(var e in f)f[e].admin_level=c(f[e]),f[e].location=d(f[e])})},a}]),angular.module("ng.simple.table",[]).filter("limitColumnWidth",function(){return function(a,b){return a&&a.length>=b?a.substring(0,b-4)+" ...":a}}).directive("ngsimpletable",function(){return{scope:{allowFilter:"=",allowSelect:"=",allowSort:"=",arrayFields:"=",filterFieldClass:"@",filterFieldPlaceholder:"@",headerClass:"@",maxColWidth:"=",rowActions:"=",rowActionCallback:"&",rowActionClass:"@",rowActionClasses:"=",rowClass:"@",rowSelection:"=",sortCallback:"&",tableClass:"@",tableData:"=",tableHeader:"=",toggleFields:"=",toggleFieldCallback:"&",unsortableFields:"="},link:function(a,b,c){function d(){for(var b=[],c=0;c<a.tableData.length;c++)b.push(!1);return b}a.rowSelection=d(),a.searchString="",a.selectAll=!1,a.tableDataCopy=a.tableData,a.toggleFieldsName=_.map(a.toggleFields,"name"),a.$watch("tableData",function(b,c){a.rowSelection=d(),a.tableData.length>a.tableDataCopy.length&&(a.tableDataCopy=a.tableData)}),a.filter=function(){a.tableData=a.tableDataCopy,a.searchString&&0!==a.searchString.length&&(a.tableData=a.tableData.filter(function(b){for(var c in a.tableHeader)if(b[a.tableHeader[c]].toString().toLowerCase().startsWith(a.searchString.toLowerCase()))return!0;return!1})),a.rowSelection=d()},a.sort=function(b){a.sortBy&&a.sortBy===a.tableHeader[b]?a.sortDirection&&"asc"===a.sortDirection?a.sortDirection="desc":a.sortDirection="asc":(a.sortBy=a.tableHeader[b],a.sortDirection="asc"),a.sortCallback({by:a.sortBy,direction:a.sortDirection})},a.toggleSelectAll=function(){a.rowSelection=a.rowSelection.map(function(){return a.selectAll})}},restrict:"AEC",replace:!0,templateUrl:"components/ng-simple-table/template.html"}}),angular.module("ng.simple.pagination",[]).directive("ngsimplepagination",function(){return{scope:{currentPage:"=",total:"=",pageSize:"=",offset:"=",onPageRequested:"&"},link:function(a,b,c){function d(b){a.currentPage=b,a.pageStart=a.currentPage*a.pageSize+1,a.pageEnd=a.pageStart+a.pageSize-1,a.pageStart>a.total&&(a.pageStart=a.total),a.pageEnd>a.total&&(a.pageEnd=a.total);var c=b*a.pageSize;0>c&&(c=0),a.onPageRequested({limit:a.pageStart,skip:c})}function e(){a.pageCount=Math.ceil(a.total/a.pageSize),a.pageStart=a.currentPage*a.pageSize+1,a.pageEnd=a.pageStart+a.pageSize-1,a.pageStart>a.total&&(a.pageStart=a.total),a.pageEnd>a.total&&(a.pageEnd=a.total)}a.pageCount=0,a.pageResized=!1,a.pageStart=0,a.pageEnd=0,a.$watch("total",function(a,b){e()}),a.$watch("currentPage",function(a,b){d(a)}),a.navigateTo=function(a){d(a)}},restrict:"AEC",replace:!0,templateUrl:"components/ng-simple-pagination/template.html"}}),angular.module("app.user").service("alertService",function(){this.showMessage=function(a){humane.log(a)},this.showSuccessMessage=function(a){humane.log(a,{addnCls:"humane-flatty-success"})},this.showInfoMessage=function(a){humane.log(a,{addnCls:"humane-flatty-info"})},this.showErrorMessage=function(a){humane.log(a,{addnCls:"humane-flatty-error"})}}),angular.module("app.navbar",[]).controller("navbarCtrl",["$http","NAVIGATION","CURRENT_USER",function(a,b,c){function d(){return a.get(window.location.protocol+"//"+window.location.host+c.url).then(function(a){var b=a.data,d="",f=c.name_field.split(".");for(var g in f)d=b[f[g]];e.username=d})}var e=this;e.additionalNavigation=b,e.username="",d(),e.navigateTo=function(a,b){var c;switch(a){case 0:c=e.additionalNavigation.customNavbarLinks[b].url;break;case 1:c=e.additionalNavigation.sidebarLinks[b].url;break;case 2:c=e.additionalNavigation.userDropdown[b].url}0===c.indexOf("/")?window.location=window.location.protocol+"//"+window.location.host+c:window.location=c}}]);